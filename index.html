<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexDeal Nav Bar - Reseller Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .animated-gradient-bg {
            background: linear-gradient(45deg, #0f0c29, #302b63, #24243e, #1c1c3c);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
        }
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .main-content {
            display: none;
        }
        .glass-panel {
            background: rgba(22, 22, 34, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .title-gradient {
            background: -webkit-linear-gradient(45deg, #89f7fe, #66a6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #66a6ff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="animated-gradient-bg text-gray-200 antialiased">

    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4 transition-opacity duration-500">
        <div class="w-full max-w-md glass-panel rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold title-gradient">FlexDeal Nav Bar</h1>
                <p class="text-gray-400 mt-2">Secure Reseller Portal</p>
            </div>
            <form id="login-form">
                <div id="login-error" class="text-red-400 text-center mb-4 hidden rounded-lg bg-red-500/10 p-3 text-sm"></div>
                <div class="space-y-6">
                    <div>
                        <label for="username" class="text-sm font-medium text-gray-300">Email</label>
                        <div class="mt-2 relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3.5">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                            </span>
                            <input type="email" id="username" name="username" placeholder="Enter your email" class="w-full bg-black/20 border border-white/10 rounded-lg py-3 pl-11 pr-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition duration-300" required>
                        </div>
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-gray-300">Password</label>
                         <div class="mt-2 relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3.5">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                            </span>
                            <input type="password" id="password" name="password" placeholder="Enter your password" class="w-full bg-black/20 border border-white/10 rounded-lg py-3 pl-11 pr-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 transition duration-300" required>
                        </div>
                    </div>
                </div>
                <div class="mt-8">
                    <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40 transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                        Login
                    </button>
                </div>
                 <div class="text-center mt-4">
                    <a href="#" class="text-sm text-cyan-400 hover:text-cyan-300">Forgot Password?</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content / Dashboard -->
    <div id="dashboard-section" class="main-content min-h-screen">
        <!-- Header -->
        <header class="bg-black/30 backdrop-blur-lg sticky top-0 z-20 border-b border-white/10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold title-gradient">FlexDeal</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="welcome-message" class="text-gray-300 hidden sm:block">Welcome!</span>
                        <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Account List -->
            <div class="glass-panel rounded-2xl shadow-xl p-6">
                <h2 class="text-2xl font-bold text-white mb-6">Managed Netflix Accounts</h2>
                <div id="accounts-loader" class="flex justify-center items-center p-8"><div class="loader"></div></div>
                <div class="overflow-x-auto hidden" id="accounts-table-container">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-white/10">
                                <th class="p-4 text-sm font-semibold text-gray-300 uppercase tracking-wider">Account Name</th>
                                <th class="p-4 text-sm font-semibold text-gray-300 uppercase tracking-wider hidden md:table-cell">Associated Gmail</th>
                                <th class="p-4 text-sm font-semibold text-gray-300 uppercase tracking-wider hidden sm:table-cell">End Date</th>
                                <th class="p-4 text-sm font-semibold text-gray-300 uppercase tracking-wider text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-table-body">
                            <!-- JS will populate this from Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Support & Resources -->
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- FAQ -->
                <div class="glass-panel rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-white mb-6">Frequently Asked Questions</h2>
                    <div id="faq-loader" class="flex justify-center items-center p-8"><div class="loader"></div></div>
                    <div class="space-y-4 hidden" id="faq-container">
                        <!-- FAQ items will be added here from Firebase -->
                    </div>
                </div>
                <!-- Contact -->
                <div class="glass-panel rounded-2xl shadow-xl p-6">
                     <h2 class="text-2xl font-bold text-white mb-6">Need Help?</h2>
                     <p class="text-gray-400 mb-4">If you encounter any issues or have questions not covered in the FAQ, please reach out to our support team.</p>
                     <div class="bg-black/20 p-4 rounded-lg border border-white/10">
                        <p class="font-semibold text-white">Support Email:</p>
                        <a href="mailto:support@flexdeal.com" class="text-cyan-400 hover:text-cyan-300">support@flexdeal.com</a>
                     </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal for Password Reset Code -->
    <div id="reset-code-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="modal-content" class="modal-content glass-panel rounded-2xl shadow-2xl w-full max-w-sm p-6 transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Password Reset</h3>
                <button id="close-modal-button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-body">
                <!-- Content will be set by JS -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBP7Wvvwh3FB3AQX-k2L1xB2sb2ZfLp1z8",
          authDomain: "netfil-46500.firebaseapp.com",
          projectId: "netfil-46500",
          storageBucket: "netfil-46500.appspot.com",
          messagingSenderId: "23661896274",
          appId: "1:23661896274:web:8a938d355338abe96fb58b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM ELEMENTS ---
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const welcomeMessage = document.getElementById('welcome-message');
        
        const accountsTableBody = document.getElementById('accounts-table-body');
        const accountsLoader = document.getElementById('accounts-loader');
        const accountsTableContainer = document.getElementById('accounts-table-container');

        const faqContainer = document.getElementById('faq-container');
        const faqLoader = document.getElementById('faq-loader');

        const modal = document.getElementById('reset-code-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalButton = document.getElementById('close-modal-button');
        const modalBody = document.getElementById('modal-body');
        const loginError = document.getElementById('login-error');

        // --- FIREBASE FUNCTIONS ---

        async function populateAccountsTable() {
            accountsLoader.style.display = 'flex';
            accountsTableContainer.classList.add('hidden');
            accountsTableBody.innerHTML = ''; 

            try {
                const querySnapshot = await getDocs(collection(db, "accounts"));
                if (querySnapshot.empty) {
                    accountsTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-400">No accounts found.</td></tr>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const account = doc.data();
                        const row = document.createElement('tr');
                        row.className = 'border-b border-white/10 hover:bg-white/5 transition-colors duration-200';
                        row.innerHTML = `
                            <td class="p-4 font-medium text-white">${account.name || 'N/A'}</td>
                            <td class="p-4 text-gray-400 hidden md:table-cell">${account.email || 'N/A'}</td>
                            <td class="p-4 text-gray-400 hidden sm:table-cell">${account.endDate || 'N/A'}</td>
                            <td class="p-4 text-center">
                                <button class="get-code-btn bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 text-sm shadow-lg shadow-sky-500/20" data-id="${doc.id}">
                                    Get Code
                                </button>
                            </td>
                        `;
                        accountsTableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error("Error fetching accounts: ", error);
                accountsTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-400">Error loading accounts: ${error.message}</td></tr>`;
            } finally {
                accountsLoader.style.display = 'none';
                accountsTableContainer.classList.remove('hidden');
            }
        }
        
        async function populateFaqs() {
            faqLoader.style.display = 'flex';
            faqContainer.classList.add('hidden');
            faqContainer.innerHTML = '';

            try {
                const querySnapshot = await getDocs(collection(db, "faqs"));
                 if (querySnapshot.empty) {
                    faqContainer.innerHTML = '<p class="text-gray-400">No FAQs found.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const faq = doc.data();
                        const faqItem = document.createElement('div');
                        faqItem.className = 'glass-panel rounded-lg';
                        faqItem.innerHTML = `
                            <button class="faq-question w-full text-left flex justify-between items-center p-4 hover:bg-white/5 rounded-lg focus:outline-none transition-colors duration-300">
                                <span class="font-semibold text-white">${faq.q || 'No Question'}</span>
                                <svg class="w-5 h-5 text-gray-400 transform transition-transform duration-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div class="faq-answer hidden p-4 pt-0 text-gray-400 rounded-b-lg">
                                ${faq.a || 'No Answer'}
                            </div>
                        `;
                        faqContainer.appendChild(faqItem);
                    });
                }
            } catch (error) {
                console.error("Error fetching FAQs: ", error);
                faqContainer.innerHTML = `<p class="text-red-400">Error loading FAQs: ${error.message}</p>`;
            } finally {
                 faqLoader.style.display = 'none';
                 faqContainer.classList.remove('hidden');
            }
        }
        
        async function showModal(accountId) {
            modalBody.innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);

            try {
                const docRef = doc(db, "accounts", accountId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const account = docSnap.data();
                    let contentHtml = '';
                    if (account.resetCode) {
                        contentHtml = `
                            <p class="text-gray-400 mb-2">Reset code for <strong class="text-white">${account.name}</strong>:</p>
                            <div class="bg-black/20 p-3 rounded-lg text-center my-4 border border-white/10">
                                <p id="reset-code-text" class="text-2xl font-bold tracking-widest text-green-400">${account.resetCode}</p>
                            </div>
                            <button id="copy-code-btn" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition-colors duration-300">Copy Code</button>
                        `;
                    } else {
                        contentHtml = `
                            <p class="text-gray-400 mb-2">No pre-generated code for <strong class="text-white">${account.name}</strong>.</p>
                            <p class="text-gray-400 mt-4">Please initiate the password reset process directly on the Netflix website using the associated email: <strong class="text-white">${account.email}</strong></p>
                        `;
                    }
                    modalBody.innerHTML = contentHtml;

                    const copyBtn = document.getElementById('copy-code-btn');
                    if (copyBtn) {
                        copyBtn.onclick = () => {
                            const codeText = document.getElementById('reset-code-text').innerText;
                            const textarea = document.createElement('textarea');
                            textarea.value = codeText;
                            document.body.appendChild(textarea);
                            textarea.select();
                            try {
                                document.execCommand('copy');
                                copyBtn.innerText = 'Copied!';
                                copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                                copyBtn.classList.add('bg-gray-600');
                                setTimeout(() => {
                                    copyBtn.innerText = 'Copy Code';
                                    copyBtn.classList.remove('bg-gray-600');
                                    copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                                }, 2000);
                            } catch (err) { console.error('Failed to copy text: ', err); }
                            document.body.removeChild(textarea);
                        };
                    }
                } else {
                    modalBody.innerHTML = '<p class="text-red-400 text-center">Account not found.</p>';
                }
            } catch (error) {
                console.error("Error fetching account details:", error);
                modalBody.innerHTML = '<p class="text-red-400 text-center">Error loading details.</p>';
            }
        }

        function hideModal() {
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- EVENT LISTENERS & APP FLOW ---

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                console.log("User is signed in:", user.uid);
                welcomeMessage.textContent = `Welcome, ${user.email}`;
                loginSection.style.display = 'none';
                dashboardSection.style.display = 'block';
                populateAccountsTable();
                populateFaqs();
            } else {
                // User is signed out
                console.log("User is signed out.");
                dashboardSection.style.display = 'none';
                loginSection.style.display = 'flex';
                loginSection.classList.remove('opacity-0');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.username.value;
            const password = loginForm.password.value;
            
            const loginButton = loginForm.querySelector('button[type="submit"]');
            const originalButtonHTML = loginButton.innerHTML;
            loginButton.innerHTML = `<div class="loader mx-auto"></div>`;
            loginButton.disabled = true;
            loginError.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle showing the dashboard
            } catch (error) {
                console.error("Login failed:", error.code, error.message);
                loginError.textContent = 'Login failed. Please check your email and password.';
                loginError.classList.remove('hidden');
                loginButton.innerHTML = originalButtonHTML;
                loginButton.disabled = false;
            }
        });

        logoutButton.addEventListener('click', () => {
            signOut(auth).catch((error) => {
                console.error("Sign out failed:", error);
            });
        });

        accountsTableBody.addEventListener('click', (e) => {
            const getCodeButton = e.target.closest('.get-code-btn');
            if (getCodeButton) {
                showModal(getCodeButton.getAttribute('data-id'));
            }
        });

        faqContainer.addEventListener('click', (e) => {
            const questionButton = e.target.closest('.faq-question');
            if (questionButton) {
                const answer = questionButton.nextElementSibling;
                const icon = questionButton.querySelector('svg');
                answer.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            }
        });

        closeModalButton.addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modal.classList.contains('hidden')) hideModal(); });

    </script>
</body>
</html>
